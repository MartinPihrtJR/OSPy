$def with (program)

$var title: Modify Program
$var page: programs

$code:
    def two_digits(n):
        return '%02d' % int(n)


<script>
    $for index, name in ProgramType.NAMES.iteritems():
        var ${name} = ${index};

    function check_repeat() {
        if (jQuery("#simple_repeat").prop('checked')) {
            jQuery(".repeat").show()
        } else {
            jQuery(".repeat").hide()
        }
    }

    function check_type() {
        var schedule_type = jQuery("#schedule_type").val();
        if (schedule_type == DAYS_SIMPLE || schedule_type == DAYS_ADVANCED) {
            jQuery("#days_controls").show()
        } else {
            jQuery("#days_controls").hide()
        }
        if (schedule_type == REPEAT_SIMPLE || schedule_type == REPEAT_ADVANCED) {
            jQuery("#repeat_controls").show()
        } else {
            jQuery("#repeat_controls").hide()
        }
        if (schedule_type == REPEAT_SIMPLE || schedule_type == DAYS_SIMPLE) {
            jQuery("#simple_controls").show()
        } else {
            jQuery("#simple_controls").hide()
        }
        if (schedule_type == REPEAT_ADVANCED || schedule_type == DAYS_ADVANCED) {
            jQuery("#advanced_controls").show()
        } else {
            jQuery("#advanced_controls").hide()
        }
        if (schedule_type == WEEKLY_ADVANCED) {
            jQuery("#weekly_controls").show()
        } else {
            jQuery("#weekly_controls").hide()
        }
        if (schedule_type == CUSTOM) {
            jQuery("#custom_controls").show()
        } else {
            jQuery("#custom_controls").hide()
        }
    };

    // Initialize behaviors
    jQuery(document).ready(function(){
        jQuery("#cSubmit").click(function() {
            jQuery("#programForm").submit();
        });
        jQuery("button#cCancel").click(function(){
            window.location="/programs";
        });
        jQuery("button.station.toggle").click(function(){
            var id = jQuery(this).attr("id");
            var state = jQuery(this).hasClass("on");
            jQuery(this)
                .addClass(state ? "off": "on")
                .removeClass(state ? "on" : "off");
            var stations = jQuery(".station.on").map(function() {
                return jQuery(this).attr("id").replace("station", "");
            }).get();
            jQuery("#stations").val('[' + stations.join(', ') + ']');
            return false;
        });
        jQuery("button.weekday.pushon").click(function(){
            var id = jQuery(this).attr("id");
            var state = jQuery(this).hasClass("on");
            jQuery(this)
                .addClass(state ? "off": "on")
                .removeClass(state ? "on" : "off");
            var days = jQuery(".station.on").map(function() {
                return jQuery(this).attr("id").replace("day", "");
            }).get();
            jQuery("#days").val('[' + days.join(', ') + ']');
            return false;
        });
        jQuery("#schedule_type").change(check_type);
        check_type();
        jQuery("#simple_repeat").change(check_repeat);
        check_repeat();

        jQuery("#intervalSelector").click(function() {
            var dayInterval = parseInt(jQuery("#intervalSelector .intervalSelect.distance0").text());
            var delayInterval = parseInt(jQuery("#intervalDelaySelector .intervalSelect.distance0").text());
            if (isNaN(delayInterval)) {
                delayInterval = 0;
            } else if (delayInterval >= 1 && delayInterval >= dayInterval) {
                delayInterval = dayInterval - 1;
            }
            jQuery("#intervalDelaySelector").html("");
            for (var i=0; i<dayInterval; i++) {
                jQuery("#intervalDelaySelector").append(
                        jQuery("<span class='intervalSelect'>" + i + "</span>")
                            .on("click", intervalSelectClick)
                            .on("mouseover", intervalSelectMouseover)
                            .on("mouseout", intervalSelectMouseout)
                );
                if (i == 16) {
                    jQuery("#intervalDelaySelector").append("<br/>");
                }
            }
            jQuery("#intervalDelaySelector .intervalSelect").each(function() {
                if (jQuery(this).text() == delayInterval) {
                    jQuery(this).trigger("click");
                }
            });
            jQuery("#interval").val(jQuery("#intervalSelector .intervalSelect.distance0").text());
            jQuery("#interval_delay").val(jQuery("#intervalDelaySelector .intervalSelect.distance0").text());
        });
        jQuery("#intervalDelaySelector").click(function() {
            jQuery("#interval_delay").val(jQuery("#intervalDelaySelector .intervalSelect.distance0").text());
        });
        jQuery("#intervalSelector .intervalSelect").each(function() {
            var thisValue = parseInt(jQuery(this).text());
            if (thisValue == ${program.repeat_days()}) {
                jQuery(this).trigger("click");
                jQuery("#intervalSelector").trigger("click");
            }
        });
    });
</script>

<div id="programs">
    <div class="title">${"Add a New Program" if program.index < 0 else "Edit Program #" + str(program.index+1)}</div>
    <form name="programForm" id="programForm" method="post">
        <input type="hidden" name="index" value="${program.index}">
        <input type="hidden" id="stations" name="stations" value="${program.stations}">

        <div class="simpleblock">
            <div style="display: inline-block; box-sizing: border-box; vertical-align: top; min-width: 50%">
                <div class='option' style="white-space: nowrap">
                    <span class="program_label">Name:</span>
                    <input name="name" type="text" value="${program.name}" style="width: 140px">
                </div>

                <div class='option' style="white-space: nowrap">
                    <span class="program_label">Enabled:</span>
                    <input name="enabled" type="checkbox" ${'checked' if program.enabled else ''}>
                </div>

                <div class='option' style="white-space: nowrap">
                    <span class="program_label">Schedule type:</span>
                    <select id="schedule_type" name="schedule_type" style="width: 140px">
                        $for value in sorted(ProgramType.FRIENDLY_NAMES.keys()):
                            <option value="${value}" ${'selected' if program.type == value else ''}>${ProgramType.FRIENDLY_NAMES[value]}</option>
                    </select>
                </div>

            </div>
            <div style="display: inline-block; box-sizing: border-box; vertical-align: top;">
            $for station in stations.get():
                $if station.enabled and not station.is_master:
                    <div style="padding: 0; white-space: nowrap;">
                        <div class="program_label">${station.name}:</div>
                        <div style="display: inline-block; padding: 0">
                            <button id="station${station.index}" class="station toggle narrow ${'on' if station.index in program.stations else 'off'}">
                                <span class="toggleleft">On</span>
                                <span class="togglesep">&nbsp;</span>
                                <span class="toggleright">Off</span>
                            </button>
                        </div>
                    </div>
            </div>
        </div>

        <div class="simpleblock" id="days_controls" style="display: none;">
            <input type="hidden" id="days" name="days" value="">
            <div class='option'>
                <span class="program_label">Days:</span>
                <div style="display: inline-block;">
                    $for day in xrange(7):
                        <button id="day${day}" class="weekday pushon ${'on' if day in program.days() else 'off'}">${long_day(day)}</button>
                </div>
            </div>
        </div>

        <div class="simpleblock" id="repeat_controls" style="display: none;">
            <input type="hidden" id="interval" name="interval" value="">
            <input type="hidden" id="interval_delay" name="interval_delay" value="">
            <div class='option'>
                <span class="program_label">Water interval:</span>
                <div id="intervalSelector" class="animatedSelector simpleinlineblock" >
                    <!--  Customize this with any set of intervals you like up to 127 -->
                    $for days in range(1, 8) + [10, 12, 14, 15, 21, 30]:
                        <span class="intervalSelect">${days}</span>
                </div>
            </div>
            <div class='option'>
                <span class="program_label">Starting in:</span>
                <div id="intervalDelaySelector" class="animatedSelector simpleinlineblock">
                    <span class="intervalSelect distance0">0</span>
                    <span class="intervalSelect distance1">1</span>
                </div>
            </div>
        </div>

        <div class="simpleblock" id="simple_controls" style="display: none;">
            <div class='option' style="white-space: nowrap">
                <span class="program_label">Start time:</span>
                <input name="simple_hour" type="number" maxlength="2" value="${two_digits(program.start_min()/60)}" style="width: 60px" min="0" max="23"> :
                <input name="simple_minute" type="number" maxlength="2" value="${two_digits(program.start_min()%60)}" style="width: 60px" min="0" max="59">
            </div>
            <div class='option' style="white-space: nowrap">
                <span class="program_label">Duration:</span>
                <input name="simple_duration" type="number" maxlength="4" value="${program.duration_min()}" style="width: 60px" min="0" max="1440">
                minute(s)
            </div>
            <div class='option' style="white-space: nowrap">
                <span class="program_label">Repeat:</span>
                <input id="simple_repeat" name="simple_repeat" type="checkbox" ${'checked' if program.repeat_times() > 0 else ''}>
            </div>
            <div class='repeat option' style="white-space: nowrap">
                <span class="program_label">Repetitions:</span>
                <input name="simple_rcount" type="number" maxlength="1" value="${program.repeat_times()}" style="width: 60px" min="0" max="9">
                time(s)
            </div>
            <div class='repeat option' style="white-space: nowrap">
                <span class="program_label">Pause:</span>
                <input name="simple_pause" type="number" maxlength="1" value="${program.pause_min()}" style="width: 60px" min="0" max="1440">
                minute(s)
            </div>
        </div>

        <div class="simpleblock" id="advanced_controls" style="display: none;">
            Advanced
        </div>

        <div class="simpleblock" id="weekly_controls" style="display: none;">
            Weekly
        </div>

        <div class="simpleblock" id="custom_controls" style="display: none;">
            Custom
        </div>

    </form>
</div>

<div id="controls">
    <button id="cSubmit" class="submit"><b>Save</b></button>
    <button id="cCancel" class="cancel danger">Cancel</button>
    <span id="errorHint"></span>
</div>