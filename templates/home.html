$def with ()

$var title: OpenSprinkler Pi
$var page: home

$# For some reason the functions below do not work in a single $code block
$code:
	def two_digits(n):
		return '%02d' % int(n)

$code:
    def plugin_adjustment():
        # FIXME
        return 1.0

        #return '%.0f' % options.level_adjustment
        #result = 100.0
        #for entry in duration_adjustments:
        #    result *= entry/100.0
        #return '%.0f' % result
$code:
    def plugin_adjustment_list():
        return [1.0,]

        #duration_adjustments = options.level_adjustment
        #result = []
        #for entry in duration_adjustments:
        #    result.append('%.0f%%' % entry)
        #return ' * '.join(result)

$code:
    def total_adjustment():
        return '1.0'

        # duration_adjustments = [gv.sd[entry] for entry in gv.sd if entry.startswith('wl_')]
        # result = float(gv.sd["wl"])
        #for entry in duration_adjustments:
        #    result *= entry/100.0
        #return '%.0f' % result

<script>

    function formatLogline(log) {
        var lrsid = lrun[0], lrpid = lrun[1], lrdur = lrun[2], lret = lrun[3];
        if (lrpid == 0) {
            return "n/a";
        }
        var pname = "P" + lrpid;
        if (lrpid == 255 || lrpid == 99) {
            pname = "Manual Mode";
        }
        if (lrpid == 254 || lrpid == 98) {
            pname = "Run Once Program";
        }
        var runDate = (new Date(lret*1000)).toString(); // + timezoneSuffix; //dk
        return snames[lrsid] + " ran " + pname + " for " + (lrdur/60>>0) + "m" + (lrdur%60) + "s on " + runDate;
    }

    function updateStatus(status) {
        var display, updateInterval = 30000;
        for (var s=0; s<status.length; s++) {
            var station = status[s];
            var classes = "stationStatus station_" + station.status;
            switch (station.reason) {
                case "program" :
                    var minutes = Math.floor(station.remaining/60);
                    var seconds = Math.floor(station.remaining - 60*minutes);
                    if (minutes < 10) {minutes = "0"+minutes;}
                    if (seconds < 10) {seconds = "0"+seconds;}
                    if (station.status == "on") {
                        display = minutes+":"+seconds;
                    } else {
                        display = "(" + minutes+":"+seconds + ")";
                    }
                    updateInterval = 1000;
                    break;
                case "master" :
                    classes += " master";
                    if (station.status == "on") {
                        display = "Master On";
                    } else {
                        display = "Master Off";
                        classes += " strike";
                    }
                    break;
                case "rain_delay" :
                    display = "Suppressed by Rain Delay";
                    break;
                case "rain_sensed" :
                    display = "Suppressed by Rain Sensor";
                    break;
                default:
                    display = "Off";
            }
            jQuery("td#status" + station.station)
                .text(display)
                .removeClass()
                .addClass(classes);
        }
        setTimeout(statusTimer,updateInterval);
        if (updateInterval > 1000) {

            displayProgram();
        }
    }
    function statusTimer() {
        jQuery.getJSON("/api/status", updateStatus)
    }

    function countdownTimer(el) {
        alert(jQuery(el).html());
    }

    // Initialize behaviors
    jQuery(document).ready(function(){
        $if options.manual_mode == 0:
            statusTimer();

        jQuery("button#cStartStop").click(function(){
            jQuery("form[name='hf'] input[name='en']").val(1-en);
            jQuery("form[name='hf']").submit();
        });

        jQuery("button#cManual").click(function(){
            jQuery("form[name='hf'] input[name='mm']").val(1-mm);
            jQuery("form[name='hf']").submit();
        });

        jQuery("button#cRainDelay").click(function(){
            if (rd != 0) {
                var h = 0;
            } else {
                var h = prompt("Enter hours to delay","0");
            }
            if (h != null){
                jQuery("form[name='hf'] input[name='rd']").val(h);
                jQuery("form[name='hf']").submit();
            }
        });

        jQuery("button#cWaterLevel").click(function(){
            if (wl != 100) {
                var w = 100;
            } else {
                var w = prompt("Enter percentage adjustment",wl);
            }
            if (w != null){
                jQuery("form[name='hf'] input[name='wl']").val(w);
                jQuery("form[name='hf']").submit();
            }
        });

        jQuery("button.manual").click(function () {
            sid = parseInt(jQuery(this).attr("id"));
            sbit = jQuery(this).hasClass("on");
            if (sbit) {
                window.location = "/sn?sid="+(sid+1)+"&set_to=0"; // turn off station
            } else {
                var strmm = jQuery("#mm"+sid).val();
                var strss = jQuery("#ss"+sid).val();
                var mm = (strmm == "" ? 0 : parseInt(strmm));
                var ss = (strss == "" ? 0 : parseInt(strss));
                if (!(mm >= 0 && ss >= 0 && ss < 60)) {
                    alert("Timer values wrong: " + strmm + ":" + strss);
                    return;
                }
                window.location = "/sn?sid=" + (sid+1) + "&set_to=1" + "&set_time=" + (mm*60+ss);  // turn it off with timer
            }
        });

        jQuery("button#pStopAll").click(function(){
            window.location="/cv?rsn=1";
        });

        jQuery("button#pPrev").click(function() {
            displayScheduleDate.setDate(displayScheduleDate.getDate() - 1);
            displayProgram();
        });
        jQuery("button#pToday").click(function() {
            var day = new Date()//dk
            displayScheduleDate.setDate(day.getDate());
            displayScheduleDate.setMonth(day.getMonth()); //dk
            displayProgram();
        });
        jQuery("button#pNext").click(function() {
            displayScheduleDate.setDate(displayScheduleDate.getDate() + 1);
            displayProgram();
        });

        jQuery(".countdown").each(function() {
            countdownTimer(jQuery(this).attr('id'));
        });
    });

    function countdownTimer(timerId) {
        var timerElement = jQuery("#" + timerId);
        var timerValue = parseFloat(timerElement.attr("data"));
        var remaining = timerValue - devt; //Date.now(); // DK change
        var rHours = Math.floor(remaining/3600000);
        var rMinutes = Math.floor((remaining%3600000)/60000);
        if (rHours <=0 && rMinutes <=0) {
            window.location = "/";
        } else {
            timerElement.text((rHours<10 ? "0" : "") + rHours + ":" + (rMinutes<10 ? "0" : "") + rMinutes);
            setTimeout("countdownTimer('" + timerId + "')", 2000);
        }
    }
</script>
<div id="options">
    <button id="cStartStop" class="toggle ${'on' if options.system_enabled else 'off'}"><span class='toggleleft'>System On</span><span class='togglesep'>&nbsp;</span><span class='toggleright'>System Off</span></button>
    <br>
    $#<button id="cWaterLevel" class="toggle choice ${'on' if options.level_adjustment==100 else 'off'}"><span class='toggleleft'>Normal</span><span class='togglesep'>&nbsp;</span><span class='toggleright'>${'Water Level' if options.level_adjustment==100 else str(options.level_adjustment) + '% Level'}</span></button>${'' if int(plugin_adjustment()) == 100 else ' Plugin adjustments: ' + plugin_adjustment_list() + ('' if options.level_adjustment==100 and '*' not in plugin_adjustment_list() else ' - Total adjustment: ' + total_adjustment() + '%')}
    $#<br>
    <button id="cRainDelay" class="toggle ${'off' if rain_blocks or (options.rain_sensor_enabled and inputs.rain_input) else 'on'}"><span class='toggleleft'>Active</span><span class='togglesep'>&nbsp;</span><span class='toggleright'>Rain Delay</span></button>
    $#$if rain_blocks:
    $#    ${'<span class="countdown" id="rainDelayCountdown" data=" str(rain_blocks.block_end()) "></span>' if rain_blocks else ''}
    $if options.rain_sensor_enabled:
        <span class="rainsense">${'' if inputs.rain_input else 'no'} rain sensed</span>
    <br>
    <button id="cManual" class="toggle choice ${'off' if options.manual_mode else 'on'}"><span class='toggleleft'>Auto</span><span class='togglesep'>&nbsp;</span><span class='toggleright'>Manual</span></button>
</div>

<div id="stationsdiv">

$if options.manual_mode:
    <div id="manualmode">
        <table id="stations" class="stationList">
        <!-- FIXME -->
        $# Manual program control formatting
        $for bid in range(0, gv.sd['nbrd']):
            $for s in range(0,8):
                $ sid = bid*8 + s;
                $ sn = sid + 1
                $ sbit = (gv.sbits[bid]>>s)&1
                $ show = (gv.sd['show'][bid]>>s)&1
                $if show == 1:
                    <tr>
                        <td class='station_name'>${snames[sid]}</td>
                        $if sn == gv.sd['mas']:
                            $if sbit:
                                <td class="master station_on">On (Master)</td>
                            $else:
                                <td class="master station_off">Off (Master)</td>
                        $else:
                            $ rem = gv.ps[sid][1]
                            $if rem > 65536:
                                $ rem = 0
                            <td class="station_running">
                                <button class='toggle manual narrow ${'on' if sbit else 'off'}' id='${sid}'><span class='toggleleft'>On</span><span class='togglesep'>&nbsp;</span><span class='toggleright'>Off</span></button>
                                    ${'in' if sbit else 'for'}
                                <input type='text' id='mm${sid}' size='2' maxlength='3' value='${two_digits(rem/60)}'/>:
                                <input type='text' id='ss${sid}' size='2' maxlength='2' value='${two_digits(rem%60)}'/> (mm:ss)
                            </td>
                    </tr>
        </table>
    </div>
$else:
    <div id="programmode">
        <table id="stations" class="stationList">
            <tr>
                <td colspan="2"></td>
                <td colspan="8">
                    <span id="displayScheduleDate"></span>
                </td>
                <td colspan="16" style="text-align:right">
                    <button id="pPrev" class="execute">&lt;&lt; Prev Day</button>
                    <button id="pToday" class="execute">Today</button>
                    <button id="pNext" class="execute">Next Day &gt;&gt;</button>
                </td>
            </tr>
            <tr><td colspan="2">
                <!-- FIXME -->
                $for hour in xrange(0, 24):
                    $ t = datetime.time(hour=hour, minute=0)
                    $if options.time_format:
                        <td class="scheduleTick">$t.strftime("%H:%M")</td>
                    $else:
                        <td class="scheduleTick">$t.strftime("%I %p")</td>
                <!--<td class="scheduleTick">${'00:00' if options.time_format else '12 AM'}</td>-->
                <!--<td class="scheduleTick">${'01:00' if options.time_format else '1 AM'}</td>-->
                <!--<td class="scheduleTick">${'02:00' if options.time_format else '2 AM'}</td>-->
                <!--<td class="scheduleTick">${'03:00' if options.time_format else '3 AM'}</td>-->
                <!--<td class="scheduleTick">${'04:00' if options.time_format else '4 AM'}</td>-->
                <!--<td class="scheduleTick">${'05:00' if options.time_format else '5 AM'}</td>-->
                <!--<td class="scheduleTick">${'06:00' if options.time_format else '6 AM'}</td>-->
                <!--<td class="scheduleTick">${'07:00' if options.time_format else '7 AM'}</td>-->
                <!--<td class="scheduleTick">${'08:00' if options.time_format else '8 AM'}</td>-->
                <!--<td class="scheduleTick">${'09:00' if options.time_format else '9 AM'}</td>-->
                <!--<td class="scheduleTick">${'10:00' if options.time_format else '10 AM'}</td>-->
                <!--<td class="scheduleTick">${'11:00' if options.time_format else '11 AM'}</td>-->
                <!--<td class="scheduleTick">${'12:00' if options.time_format else '12 PM'}</td>-->
                <!--<td class="scheduleTick">${'13:00' if options.time_format else '1 PM'}</td>-->
                <!--<td class="scheduleTick">${'14:00' if options.time_format else '2 PM'}</td>-->
                <!--<td class="scheduleTick">${'15:00' if options.time_format else '3 PM'}</td>-->
                <!--<td class="scheduleTick">${'16:00' if options.time_format else '4 PM'}</td>-->
                <!--<td class="scheduleTick">${'17:00' if options.time_format else '5 PM'}</td>-->
                <!--<td class="scheduleTick">${'18:00' if options.time_format else '6 PM'}</td>-->
                <!--<td class="scheduleTick">${'19:00' if options.time_format else '7 PM'}</td>-->
                <!--<td class="scheduleTick">${'20:00' if options.time_format else '8 PM'}</td>-->
                <!--<td class="scheduleTick">${'21:00' if options.time_format else '9 PM'}</td>-->
                <!--<td class="scheduleTick">${'22:00' if options.time_format else '10 PM'}</td>-->
                <!--<td class="scheduleTick">${'23:00' if options.time_format else '11 PM'}</td>-->
            </tr>
            $for station in stations:
                <tr class="stationSchedule $loop.parity" id='schedule$loop.index' data="$loop.index0">
                    <td class='station_name'>$station.name</td>
                    <td id='status$loop.index0' class="stationStatus">loading...</td>
                    $for tick in xrange(0,24):
                        <td class="scheduleTick" data="$tick"></td>
                </tr>
            <tr>
                <td colspan="2" style="text-align:right">
                    <button id="pStopAll" class="execute delete">Stop All Stations</button>
                </td>
                <td colspan="24" id="legend" style="text-align:center">
                    <span class='program1'>Program 1</span>
                </td>
            </tr>
        </table>
    </div>

</div>

<div id="controls">
    <!--FIXME all actions need to POST-->
    <form name="hf" action="cv" method="get">
        <input type="hidden" name="en">
        <input type="hidden" name="mm">
        <input type="hidden" name="rd">
        <input type="hidden" name="wl">
        <input type="hidden" name="rbt" value="0">
    </form>
</div>

